name: Sync Main to Dev

on:
  workflow_run:
    workflows: ['Auto Version Bump']
    types: [completed]
  workflow_dispatch:

jobs:
  create-pr:
    name: å»ºç«‹ main â†’ dev åŒæ­¥ PR
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: å»ºç«‹ PRï¼ˆmain â†’ devï¼‰
        id: open_pr
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” é–‹å§‹æª¢æŸ¥ main â†’ dev åŒæ­¥ç‹€æ…‹...');
            console.log('');

            // å¾ main çš„ package.json è®€å–ç‰ˆæœ¬
            const { data: pkg } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'package.json',
              ref: 'main'
            });
            const content = Buffer.from(pkg.content, 'base64').toString('utf8');
            const version = JSON.parse(content).version;
            core.setOutput('version', version);

            console.log(`ğŸ“¦ Main åˆ†æ”¯ç‰ˆæœ¬: v${version}`);
            console.log('');

            // æª¢æŸ¥ main å’Œ dev çš„ commit å·®ç•°
            try {
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: 'dev',
                head: 'main'
              });
              
              console.log(`ğŸ“Š Main é ˜å…ˆ Dev ${comparison.ahead_by} å€‹ commits`);
              console.log(`ğŸ“Š Dev é ˜å…ˆ Main ${comparison.behind_by} å€‹ commits`);
              
              if (comparison.ahead_by === 0) {
                console.log('');
                console.log('âœ… Dev åˆ†æ”¯å·²ç¶“æ˜¯æœ€æ–°çš„ï¼Œç„¡éœ€å»ºç«‹åŒæ­¥ PR');
                core.setOutput('result', 'up-to-date');
                return;
              }
              
              console.log('');
              console.log('ğŸ“ éœ€è¦åŒæ­¥çš„è®Šæ›´ï¼š');
              comparison.commits.slice(0, 5).forEach(commit => {
                console.log(`   - ${commit.sha.slice(0, 7)}: ${commit.commit.message.split('\n')[0]}`);
              });
              if (comparison.commits.length > 5) {
                console.log(`   ... é‚„æœ‰ ${comparison.commits.length - 5} å€‹ commits`);
              }
              console.log('');
            } catch (error) {
              console.log(`âš ï¸ ç„¡æ³•æ¯”è¼ƒåˆ†æ”¯: ${error.message}`);
              console.log('ç¹¼çºŒæª¢æŸ¥æ˜¯å¦éœ€è¦å»ºç«‹ PR...');
              console.log('');
            }

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰é–‹å•Ÿçš„ main â†’ dev PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'dev',
              head: `${context.repo.owner}:main`
            });

            if (prs.length > 0) {
              console.log(`â„¹ï¸ å·²å­˜åœ¨åŒæ­¥ PR #${prs[0].number}: ${prs[0].html_url}`);
              console.log(`   ç‹€æ…‹: ${prs[0].state}`);
              console.log(`   æ¨™é¡Œ: ${prs[0].title}`);
              core.setOutput('result', 'exists');
              core.setOutput('pr_number', String(prs[0].number));
              core.setOutput('pr_url', prs[0].html_url);
              return;
            }

            console.log('ğŸ“Œ æ²’æœ‰é–‹å•Ÿçš„åŒæ­¥ PRï¼Œæº–å‚™å»ºç«‹æ–°çš„...');
            console.log('');

            const title = `chore(release): sync main to dev v${version}`;
            const body = [
              'ğŸš€ è‡ªå‹•å°‡ main çš„ç‰ˆæœ¬è®Šæ›´åŒæ­¥åˆ° dev',
              '',
              `- æ–°ç‰ˆæœ¬: v${version}`,
              `- ä¾†æº: main â†’ dev`,
              '',
              'æ­¤ PR å°‡åœ¨ CI é€šéå¾Œç”± Auto Merge to Dev workflow ä»¥ Rebase æ¨¡å¼è‡ªå‹•åˆä½µï¼ˆç¬¦åˆ Require linear historyï¼‰'
            ].join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: 'main',
              base: 'dev',
              body
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['auto-sync', 'release']
            });

            console.log(`âœ… å·²å»ºç«‹åŒæ­¥ PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('result', 'created');
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('pr_url', pr.html_url);

            // å˜—è©¦å•Ÿç”¨ GitHub Auto-mergeï¼ˆéœ€è¦åˆ†æ”¯ä¿è­·è¦å‰‡ï¼‰
            console.log('');
            console.log('ğŸ” å˜—è©¦å•Ÿç”¨ GitHub å…§å»º Auto-merge...');
            try {
              await github.graphql(`
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest { number }
                  }
                }
              `, {
                pullRequestId: pr.node_id,
                mergeMethod: 'REBASE'
              });
              console.log('âœ… GitHub Auto-merge å·²å•Ÿç”¨ï¼ˆRebase æ¨¡å¼ï¼‰');
              console.log('â„¹ï¸ PR å°‡åœ¨æ‰€æœ‰æª¢æŸ¥é€šéå¾Œè‡ªå‹•åˆä½µ');
            } catch (e) {
              console.log('âš ï¸ ç„¡æ³•å•Ÿç”¨ GitHub Auto-merge');
              console.log(`   åŸå› : ${e.message}`);
              console.log('');
              console.log('ğŸ’¡ è¦å•Ÿç”¨ GitHub Auto-mergeï¼Œéœ€è¦ï¼š');
              console.log('   1. Settings â†’ General â†’ Pull Requests');
              console.log('      â˜‘ Allow auto-merge');
              console.log('');
              console.log('   2. Settings â†’ Branches â†’ Branch protection rule (dev)');
              console.log('      â˜‘ Require status checks to pass before merging');
              console.log('      â˜‘ é¸æ“‡å¿…è¦çš„æª¢æŸ¥é …ç›®ï¼ˆå¦‚ï¼šlint, test-apiï¼‰');
              console.log('');
              console.log('âœ… ä¸éæ²’é—œä¿‚ï¼Auto Merge to Dev å·¥ä½œæµç¨‹æœƒåœ¨ CI é€šéå¾Œè‡ªå‹•è™•ç†');
            }
  notify:
    name: TG é€šçŸ¥ - Sync Mainâ†’Dev
    runs-on: ubuntu-latest
    needs: create-pr
    if: always()
    steps:
      - name: å½™æ•´é€šçŸ¥å…§å®¹
        id: compose
        uses: actions/github-script@v7
        with:
          script: |
            // è®€å–ç‰ˆæœ¬
            const { data: pkg } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'package.json',
              ref: 'main'
            });
            const content = Buffer.from(pkg.content, 'base64').toString('utf8');
            const version = JSON.parse(content).version;

            // æŸ¥æ‰¾ç¾æœ‰ mainâ†’dev PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'dev',
              head: `${context.repo.owner}:main`
            });
            const pr = prs[0];

            const statusLine = (pr
              ? `*PR:* ${pr.html_url}`
              : 'ï¼ŠPRï¼šç›®å‰æ²’æœ‰é–‹å•Ÿçš„åŒæ­¥ PR');

            const body = [
              `${process.env.RESULT === 'success' ? 'ğŸ”„ *Sync Main â†’ Dev å®Œæˆ*' : 'âŒ *Sync Main â†’ Dev å¤±æ•—*'}`,
              '',
              `*å°ˆæ¡ˆ:* ${context.repo.owner}/${context.repo.repo}`,
              `*ç‰ˆæœ¬:* v${version}`,
              `*è§¸ç™¼:* ${context.payload.action || context.eventName}`,
              statusLine
            ].join('\n');

            core.setOutput('text', body);
        env:
          RESULT: ${{ needs.create-pr.result }}
      - name: ç™¼é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: ${{ steps.compose.outputs.text }}
