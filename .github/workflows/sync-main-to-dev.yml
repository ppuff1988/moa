name: Sync Main to Dev

on:
  workflow_run:
    workflows: ['Auto Version Bump']
    types: [completed]
  workflow_dispatch:

jobs:
  create-pr:
    name: å»ºç«‹ main â†’ dev åŒæ­¥ PR
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: å»ºç«‹ PRï¼ˆmain â†’ devï¼‰
        id: open_pr
        uses: actions/github-script@v7
        with:
          script: |
            // å¾ main çš„ package.json è®€å–ç‰ˆæœ¬
            const { data: pkg } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'package.json',
              ref: 'main'
            });
            const content = Buffer.from(pkg.content, 'base64').toString('utf8');
            const version = JSON.parse(content).version;
            core.setOutput('version', version);

            // è‹¥å·²æœ‰åŒæ¨£çš„é–‹å•Ÿ PRï¼Œå‰‡ç•¥éä½†è¼¸å‡º PR è³‡è¨Š
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'dev',
              head: `${context.repo.owner}:main`
            });

            if (prs.length > 0) {
              console.log(`â„¹ï¸ å·²å­˜åœ¨åŒæ­¥ PR #${prs[0].number}: ${prs[0].html_url}`);
              core.setOutput('result', 'exists');
              core.setOutput('pr_number', String(prs[0].number));
              core.setOutput('pr_url', prs[0].html_url);
              return;
            }

            const title = `chore(release): sync main to dev v${version}`;
            const body = [
              'ğŸš€ è‡ªå‹•å°‡ main çš„ç‰ˆæœ¬è®Šæ›´åŒæ­¥åˆ° dev',
              '',
              `- æ–°ç‰ˆæœ¬: v${version}`,
              `- ä¾†æº: main â†’ dev`,
              '',
              'æ­¤ PR å°‡åœ¨ CI é€šéå¾Œç”± Auto Merge to Dev workflow ä»¥ Rebase æ¨¡å¼è‡ªå‹•åˆä½µï¼ˆç¬¦åˆ Require linear historyï¼‰'
            ].join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: 'main',
              base: 'dev',
              body
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['auto-sync', 'release']
            });

            console.log(`âœ… å·²å»ºç«‹åŒæ­¥ PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('result', 'created');
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('pr_url', pr.html_url);

            // å¯é¸ï¼šå˜—è©¦å•Ÿç”¨ GitHub Auto-mergeï¼ˆRebaseï¼‰ã€‚è‹¥å€‰åº«æœªé–‹å•Ÿï¼Œæœƒè¢« try/catch åƒæ‰ã€‚
            try {
              await github.graphql(`
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest { number }
                  }
                }
              `, {
                pullRequestId: pr.node_id,
                mergeMethod: 'REBASE'
              });
              console.log('ğŸ¤– å·²å˜—è©¦å•Ÿç”¨ GitHub Auto-mergeï¼ˆRebaseï¼‰');
            } catch (e) {
              console.log(`â„¹ï¸ ç„¡æ³•å•Ÿç”¨ GitHub Auto-mergeï¼ˆå¯èƒ½æœªå•Ÿç”¨ï¼‰ï¼Œå°‡äº¤ç”± Auto Merge to Dev è™•ç†ï¼š${e.message}`);
            }

  notify:
    name: TG é€šçŸ¥ - Sync Mainâ†’Dev
    runs-on: ubuntu-latest
    needs: create-pr
    if: always()
    steps:
      - name: å½™æ•´é€šçŸ¥å…§å®¹
        id: compose
        uses: actions/github-script@v7
        with:
          script: |
            // è®€å–ç‰ˆæœ¬
            const { data: pkg } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'package.json',
              ref: 'main'
            });
            const content = Buffer.from(pkg.content, 'base64').toString('utf8');
            const version = JSON.parse(content).version;

            // æŸ¥æ‰¾ç¾æœ‰ mainâ†’dev PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'dev',
              head: `${context.repo.owner}:main`
            });
            const pr = prs[0];

            const statusLine = (pr
              ? `*PR:* ${pr.html_url}`
              : 'ï¼ŠPRï¼šç›®å‰æ²’æœ‰é–‹å•Ÿçš„åŒæ­¥ PR');

            const body = [
              `${process.env.RESULT === 'success' ? 'ğŸ”„ *Sync Main â†’ Dev å®Œæˆ*' : 'âŒ *Sync Main â†’ Dev å¤±æ•—*'}`,
              '',
              `*å°ˆæ¡ˆ:* ${context.repo.owner}/${context.repo.repo}`,
              `*ç‰ˆæœ¬:* v${version}`,
              `*è§¸ç™¼:* ${context.payload.action || context.eventName}`,
              statusLine
            ].join('\n');

            core.setOutput('text', body);
        env:
          RESULT: ${{ needs.create-pr.result }}
      - name: ç™¼é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: ${{ steps.compose.outputs.text }}
