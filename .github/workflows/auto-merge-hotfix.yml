name: Auto Merge Hotfix

on:
  workflow_run:
    workflows: ['CI Test']
    types:
      - completed

jobs:
  auto-merge-hotfix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    # åªåœ¨ä»¥ä¸‹æ¢ä»¶æ™‚åŸ·è¡Œï¼š
    # 1. CI Test æˆåŠŸ
    # 2. æ˜¯ PR äº‹ä»¶ï¼ˆä¸æ˜¯ pushï¼‰
    # 3. åˆ†æ”¯æ˜¯ hotfix/**
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      startsWith(github.event.workflow_run.head_branch, 'hotfix/')

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const associatedPRs = context.payload.workflow_run.pull_requests;

            if (!associatedPRs || associatedPRs.length === 0) {
              console.log('â„¹ï¸ æ­¤ workflow run æ²’æœ‰é—œè¯çš„ PR');
              return;
            }

            for (const associatedPR of associatedPRs) {
              // ç²å–å®Œæ•´çš„ PR è³‡è¨Š
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: associatedPR.number
              });

              // åªè™•ç† hotfix åˆ†æ”¯ä¸”ç›®æ¨™æ˜¯ main çš„ PR
              if (!pr.head.ref.startsWith('hotfix/') || pr.base.ref !== 'main' || pr.draft) {
                console.log(`â­ï¸ è·³é PR #${pr.number}: ä¸ç¬¦åˆ hotfix PR æ¢ä»¶ (hotfix/* â†’ main, é draft)`);
                continue;
              }

              const sourceBranch = pr.head.ref;
              const targetBranch = pr.base.ref;

              console.log(`ğŸš¨ è™•ç† HOTFIX PR #${pr.number}: ${sourceBranch} â†’ ${targetBranch}`);

              if (pr.mergeable_state === 'clean' || pr.mergeable_state === 'unstable') {
                // åˆä½µåˆ° main (åŠ ä¸Š fix: å‰ç¶´ä»¥è§¸ç™¼ auto version bump)
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: `fix: ğŸš¨ [HOTFIX] ${pr.title}`,
                  commit_message: `ç·Šæ€¥ä¿®å¾© - åŸå§‹ PR #${pr.number}\n\n${pr.body || ''}`
                });

                console.log(`ğŸš¨ HOTFIX PR #${pr.number} å·²è‡ªå‹•åˆä½µåˆ° main (å« fix: å‰ç¶´)`);
                console.log('â„¹ï¸ å°‡è§¸ç™¼ Auto Version Bump â†’ Sync Main to Dev æµç¨‹');

                // ç«‹å³åˆªé™¤ hotfix åˆ†æ”¯
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${sourceBranch}`
                  });
                  console.log(`ğŸ—‘ï¸ å·²åˆªé™¤ hotfix åˆ†æ”¯: ${sourceBranch}`);
                } catch (delError) {
                  console.log(`âš ï¸ åˆªé™¤åˆ†æ”¯å¤±æ•—: ${delError.message}`);
                }
              } else if (pr.mergeable_state === 'dirty') {
                console.log(`âŒ HOTFIX PR #${pr.number} æœ‰è¡çªï¼Œéœ€è¦æ‰‹å‹•è™•ç†`);

                // åŠ ä¸Š label æé†’
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['hotfix', 'merge-conflict', 'needs-attention']
                });

                // ç•™è¨€é€šçŸ¥
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: 'ğŸš¨ **HOTFIX è‡ªå‹•åˆä½µå¤±æ•—**\n\næ­¤ PR å­˜åœ¨åˆä½µè¡çªï¼Œè«‹ç«‹å³æ‰‹å‹•è™•ç†ã€‚'
                });
              } else {
                console.log(`â³ HOTFIX PR #${pr.number} ç‹€æ…‹: ${pr.mergeable_state}ï¼Œç­‰å¾…å°±ç·’`);
              }
            }

  notify:
    name: Hotfix åˆä½µé€šçŸ¥
    runs-on: ubuntu-latest
    needs: auto-merge-hotfix
    # åªåœ¨ auto-merge-hotfix å¯¦éš›åŸ·è¡Œæ™‚æ‰é€šçŸ¥ï¼ˆä¸åŒ…æ‹¬è¢«è·³éçš„æƒ…æ³ï¼‰
    # Hotfix æ˜¯ç·Šæ€¥ä¿®å¾©ï¼ŒæˆåŠŸå’Œå¤±æ•—éƒ½è¦é€šçŸ¥
    if: |
      always() && 
      needs.auto-merge-hotfix.result != 'skipped' &&
      github.event.workflow_run.event == 'pull_request' &&
      startsWith(github.event.workflow_run.head_branch, 'hotfix/')
    steps:
      - name: ğŸ“£ ç™¼é€ Hotfix åˆä½µé€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ${{ needs.auto-merge-hotfix.result == 'success' && 'ğŸš¨ *Hotfix è‡ªå‹•åˆä½µæˆåŠŸ*' || 'âŒ *Hotfix è‡ªå‹•åˆä½µå¤±æ•—*' }}

            *å°ˆæ¡ˆ:* `${{ github.repository }}`
            *åˆ†æ”¯:* `${{ github.event.workflow_run.head_branch }} â†’ main`
            *è§¸ç™¼è€…:* `${{ github.event.workflow_run.actor.login }}`

            ${{ needs.auto-merge-hotfix.result == 'success' && 'âœ… Hotfix å·²åˆä½µåˆ° main ä¸¦åˆªé™¤åˆ†æ”¯
            ğŸ”„ å·²è§¸ç™¼ sync-main-to-dev workflow' || 'âš ï¸ ç·Šæ€¥ä¿®å¾©åˆä½µå¤±æ•—ï¼Œè«‹ç«‹å³æ‰‹å‹•è™•ç†' }}

            [æŸ¥çœ‹è©³æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
