name: Auto Version Bump

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_run:
    workflows: ['Auto Merge Hotfix']
    types: [completed]

jobs:
  check-and-bump:
    runs-on: ubuntu-latest
    # å°æ–¼ PR é—œé–‰äº‹ä»¶ï¼šåªåœ¨å·²åˆä½µæ™‚åŸ·è¡Œï¼›å°æ–¼ Auto Merge Hotfixï¼šåªåœ¨æˆåŠŸå®Œæˆæ™‚åŸ·è¡Œ
    if: >-
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
    outputs:
      version_changed: ${{ steps.bump.outputs.version_changed }}
      new_version: ${{ steps.bump.outputs.new_version }}
      old_version: ${{ steps.bump.outputs.old_version }}
      bump_type: ${{ steps.bump.outputs.bump_type }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          persist-credentials: true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: åˆ†æ Commits ä¸¦è‡ªå‹•å‡ç´šç‰ˆæœ¬
        id: bump
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ ç•¶å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          if echo "$LAST_COMMIT_MSG" | grep -q "chore(release): bump version"; then
            echo "â­ï¸ è·³éç‰ˆæœ¬å‡ç´š commitï¼Œé¿å…ç„¡é™å¾ªç’°"
            echo "version_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          # å¦‚æœæ²’æœ‰ tagï¼Œä½¿ç”¨æ‰€æœ‰æäº¤è¨˜éŒ„ï¼ˆé©ç”¨æ–¼æ–°å€‰åº«ï¼‰
          if [ -z "$LAST_TAG" ]; then
            # ç²å–ç¬¬ä¸€å€‹æäº¤çš„ hash
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            COMMITS=$(git log ${FIRST_COMMIT}..HEAD --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          if [ -z "$COMMITS" ]; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²’æœ‰æ–°çš„ commits"
            exit 0
          fi

          echo "$COMMITS"

          BUMP_TYPE="none"
          if echo "$COMMITS" | grep -qiE "BREAKING CHANGE|!:"; then
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
            BUMP_TYPE="minor"
          elif echo "$COMMITS" | grep -qiE "^(fix|chore|refactor|perf|test|build|ci|docs|style)(\(.+\))?:"; then
            BUMP_TYPE="patch"
          fi

          if [ "$BUMP_TYPE" = "none" ]; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_VERSION=$(npm version $BUMP_TYPE --no-git-tag-version | sed 's/v//')
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å‡ç´šç‚º: $NEW_VERSION"

      - name: æäº¤èˆ‡æ¨é€è®Šæ›´
        if: steps.bump.outputs.version_changed == 'true'
        run: |
          NEW_VERSION=${{ steps.bump.outputs.new_version }}
          BUMP_TYPE=${{ steps.bump.outputs.bump_type }}

          git add package.json package-lock.json || true
          git commit -m "chore(release): bump version to v${NEW_VERSION}" -m "Type: ${BUMP_TYPE}"

          echo "ğŸ”„ ç¢ºä¿ main æœ€æ–°..."
          git pull --rebase origin main || true

          echo "ğŸ“¤ æ¨é€åˆ° main..."
          git push origin main || (echo "âš ï¸ ç¬¬ä¸€æ¬¡æ¨é€å¤±æ•—ï¼Œé‡è©¦..." && git pull --rebase origin main && git push origin main)

          echo "âœ… ç‰ˆæœ¬å‡ç´šå®Œæˆï¼Œtag å°‡ç”± CI Release workflow å‰µå»º"
          echo "â„¹ï¸ Sync Main to Dev workflow å°‡è‡ªå‹•å»ºç«‹åŒæ­¥ PR"

  notify:
    name: ç‰ˆæœ¬å‡ç´šé€šçŸ¥
    runs-on: ubuntu-latest
    needs: check-and-bump
    if: needs.check-and-bump.outputs.version_changed == 'true'
    steps:
      - name: ğŸ“£ ç™¼é€ç‰ˆæœ¬å‡ç´šé€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸš€ *ç‰ˆæœ¬è‡ªå‹•å‡ç´š*
            *å°ˆæ¡ˆ:* `${{ github.repository }}`
            *ç‰ˆæœ¬:* `v${{ needs.check-and-bump.outputs.old_version }}` â†’ `v${{ needs.check-and-bump.outputs.new_version }}`
            *é¡å‹:* `${{ needs.check-and-bump.outputs.bump_type }}`
            *åˆä½µè€…:* `${{ github.actor }}`
            [æŸ¥çœ‹ Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
