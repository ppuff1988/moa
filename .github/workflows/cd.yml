name: CD

on:
  workflow_run:
    workflows: ['CI Release'] # ç¢ºä¿é€™å€‹åç¨±å’Œ CI Release workflow åç¨±å®Œå…¨ç›¸åŒ
    types:
      - completed
  workflow_dispatch: # æ”¯æ´æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
    inputs:
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬è™Ÿ'
        required: false
        type: string
      tag:
        description: 'éƒ¨ç½²æ¨™ç±¤'
        required: false
        type: string
  release: # ç•¶ GitHub Release å‰µå»ºæ™‚è§¸ç™¼
    types: [published]

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“¦ è®€å–éƒ¨ç½²ç‰ˆæœ¬
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "â„¹ï¸ ä½¿ç”¨æ‰‹å‹•æŒ‡å®šç‰ˆæœ¬: $VERSION"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "â„¹ï¸ ä½¿ç”¨ Release ç‰ˆæœ¬: $VERSION"
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "â„¹ï¸ å¾ package.json è®€å–ç‰ˆæœ¬: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æº–å‚™éƒ¨ç½²ç‰ˆæœ¬: $VERSION"

      - name: ğŸ” è¨­å®š SSH é‡‘é‘°
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "ğŸ“ å¯«å…¥ SSH é‡‘é‘°..."
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "ğŸ” é©—è­‰é‡‘é‘°æ ¼å¼..."
          if ! ssh-keygen -l -f ~/.ssh/deploy_key > /dev/null 2>&1; then
            echo "âš ï¸ é‡‘é‘°æ ¼å¼å¯èƒ½æœ‰å•é¡Œï¼Œå˜—è©¦ä¿®å¾©..."
            # ç§»é™¤å¯èƒ½çš„ Windows æ›è¡Œç¬¦è™Ÿ
            dos2unix ~/.ssh/deploy_key 2>/dev/null || sed -i 's/\r$//' ~/.ssh/deploy_key
          fi

          echo "âœ… é‡‘é‘°æ¬Šé™å·²è¨­å®šç‚º 600"
          ls -la ~/.ssh/deploy_key

          echo "ğŸ”‘ æ·»åŠ  SSH known_hosts..."
          ssh-keyscan -T 10 -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts 2>  /dev/null

          echo "âœ… SSH è¨­å®šå®Œæˆ"

      - name: ğŸš€ éƒ¨ç½²åˆ°ä¼ºæœå™¨
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ vars.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || '22' }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          POSTGRES_USER: ${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ vars.POSTGRES_DB }}
          PUBLIC_GTM_ID: ${{ vars.PUBLIC_GTM_ID }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ vars.GOOGLE_REDIRECT_URI }}
          DEPLOY_URL: ${{ vars.DEPLOY_URL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ vars.SMTP_FROM_EMAIL }}
          SMTP_FROM_NAME: ${{ vars.SMTP_FROM_NAME }}
          DEPLOY_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          set -euxo pipefail

          KEY_PATH=~/.ssh/deploy_key
          SSH_OPTS=(-i "$KEY_PATH" -p "$DEPLOY_PORT" -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3)

          max_attempts=3
          attempt=1

          echo "ğŸš€ é–‹å§‹éƒ¨ç½²ç‰ˆæœ¬: $DEPLOY_VERSION"

          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ å˜—è©¦é€£ç·š (ç¬¬ $attempt/$max_attempts æ¬¡)..."
            if ssh "${SSH_OPTS[@]}" "$DEPLOY_USER@$DEPLOY_HOST" \
              "export DOCKER_USERNAME='$DOCKER_USERNAME' && \
               export DATABASE_URL='$DATABASE_URL' && \
               export DEPLOY_URL='$DEPLOY_URL' && \
               export SMTP_HOST='$SMTP_HOST' && \
               export SMTP_PORT='$SMTP_PORT' && \
               export SMTP_SECURE='$SMTP_SECURE' && \
               export SMTP_USER='$SMTP_USER' && \
               export SMTP_PASSWORD='$SMTP_PASSWORD' && \
               export SMTP_FROM_EMAIL='$SMTP_FROM_EMAIL' && \
               export SMTP_FROM_NAME='$SMTP_FROM_NAME' && \
               export JWT_SECRET='$JWT_SECRET' && \
               export POSTGRES_USER='$POSTGRES_USER' && \
               export POSTGRES_PASSWORD='$POSTGRES_PASSWORD' && \
               export POSTGRES_DB='$POSTGRES_DB' && \
               export PUBLIC_GTM_ID='$PUBLIC_GTM_ID' && \
               export GOOGLE_CLIENT_ID='$GOOGLE_CLIENT_ID' && \
               export GOOGLE_CLIENT_SECRET='$GOOGLE_CLIENT_SECRET' && \
               export GOOGLE_REDIRECT_URI='$GOOGLE_REDIRECT_URI' && \
               export DEPLOY_PATH='$DEPLOY_PATH' && \
               bash -c '
              set -euo pipefail
              
              # è¼‰å…¥ Node.js ç’°å¢ƒï¼ˆæ”¯æ´ nvm æˆ–ç›´æ¥å®‰è£çš„ Node.jsï¼‰
              export NVM_DIR=\"\$HOME/.nvm\"
              [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\"
              
              # å¦‚æœæ²’æœ‰ nvmï¼Œå˜—è©¦å°‡å¸¸è¦‹çš„ Node.js è·¯å¾‘åŠ å…¥ PATH
              if ! command -v node &> /dev/null; then
                export PATH=\"\$HOME/.local/bin:/usr/local/bin:\$PATH\"
              fi
              
              # é©—è­‰ Node.js å’Œ npm å¯ç”¨
              if ! command -v node &> /dev/null; then
                echo \"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° Node.js\"
                echo \"è«‹ç¢ºä¿ä¼ºæœå™¨å·²å®‰è£ Node.js\"
                exit 1
              fi
              
              echo \"âœ… ç•¶å‰ Node.js ç‰ˆæœ¬: \$(node -v)\"
              echo \"âœ… ç•¶å‰ npm ç‰ˆæœ¬: \$(npm -v)\"
              
              # æª¢æŸ¥ Node.js ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼ˆéœ€è¦ >= 20.19ï¼‰
              NODE_VERSION=\$(node -v | cut -d\"v\" -f2)
              NODE_MAJOR=\$(echo \$NODE_VERSION | cut -d\".\" -f1)
              NODE_MINOR=\$(echo \$NODE_VERSION | cut -d\".\" -f2)
              
              echo \"ğŸ“Š æª¢æ¸¬åˆ° Node.js ä¸»ç‰ˆæœ¬: \$NODE_MAJOR, æ¬¡ç‰ˆæœ¬: \$NODE_MINOR\"
              
              # æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼š^20.19 || ^22.12 || >=24
              NEED_UPGRADE=false
              if [ \$NODE_MAJOR -lt 20 ]; then
                NEED_UPGRADE=true
              elif [ \$NODE_MAJOR -eq 20 ] && [ \$NODE_MINOR -lt 19 ]; then
                NEED_UPGRADE=true
              elif [ \$NODE_MAJOR -eq 21 ]; then
                NEED_UPGRADE=true
              elif [ \$NODE_MAJOR -eq 22 ] && [ \$NODE_MINOR -lt 12 ]; then
                NEED_UPGRADE=true
              elif [ \$NODE_MAJOR -eq 23 ]; then
                NEED_UPGRADE=true
              fi
              
              if [ \"\$NEED_UPGRADE\" = \"true\" ]; then
                echo \"âš ï¸ Node.js ç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚ï¼ˆéœ€è¦ ^20.19 || ^22.12 || >=24ï¼‰\"
                
                # å¦‚æœæœ‰ nvmï¼Œå˜—è©¦å®‰è£/ä½¿ç”¨ç¬¦åˆè¦æ±‚çš„ç‰ˆæœ¬
                if command -v nvm &> /dev/null; then
                  echo \"ğŸ”„ ä½¿ç”¨ nvm å®‰è£ Node.js 20 LTS...\"
                  nvm install 20 --latest-npm
                  nvm use 20
                  nvm alias default 20
                  echo \"âœ… å·²åˆ‡æ›åˆ° Node.js \$(node -v)\"
                else
                  echo \"âŒ éŒ¯èª¤ï¼šNode.js ç‰ˆæœ¬å¤ªèˆŠä¸”æœªå®‰è£ nvm\"
                  echo \"è«‹å…ˆå®‰è£ nvm æˆ–å‡ç´š Node.js åˆ° 20.19+ ç‰ˆæœ¬\"
                  echo \"å®‰è£ nvm: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash\"
                  exit 1
                fi
              else
                echo \"âœ… Node.js ç‰ˆæœ¬ç¬¦åˆè¦æ±‚\"
              fi
              
              cd \$DEPLOY_PATH
              echo \"ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼...\"
              git pull origin main
              echo \"ğŸ“¦ å®‰è£ Node.js ä¾è³´ï¼ˆç”¨æ–¼åŸ·è¡Œ migrationsï¼‰...\"
              
              # æ¸…ç†å¯èƒ½æå£çš„ node_modules å’Œ package-lock
              if [ -d \"node_modules\" ]; then
                echo \"ğŸ§¹ æ¸…ç†ç¾æœ‰ node_modules...\"
                rm -rf node_modules
              fi
              
              # ä½¿ç”¨ timeout å‘½ä»¤é˜²æ­¢ npm å®‰è£å¡ä½
              # è¨­ç½® 10 åˆ†é˜è¶…æ™‚ï¼Œä¸¦æ·»åŠ æ›´å¤šæ¨™èªŒä¾†åŠ é€Ÿå®‰è£
              if timeout 360 npm ci --prefer-offline --no-audit --legacy-peer-deps 2>&1; then
                echo \"âœ… npm ä¾è³´å®‰è£æˆåŠŸ\"
              else
                EXIT_CODE=\$?
                if [ \$EXIT_CODE -eq 124 ]; then
                  echo \"âŒ npm å®‰è£è¶…æ™‚ï¼ˆè¶…é 6 åˆ†é˜ï¼‰\"
                  echo \"ğŸ”„ å˜—è©¦ä½¿ç”¨ npm install ä»£æ›¿...\"
                  timeout 600 npm install --prefer-offline --no-audit --legacy-peer_deps
                else
                  echo \"âŒ npm å®‰è£å¤±æ•—ï¼Œé€€å‡ºç¢¼: \$EXIT_CODE\"
                  exit \$EXIT_CODE
                fi
                echo "DEPLOY_URL=\$DEPLOY_URL"
                echo "SMTP_HOST=\$SMTP_HOST"
                echo "SMTP_PORT=\$SMTP_PORT"
                echo "SMTP_SECURE=\$SMTP_SECURE"
                echo "SMTP_USER=\$SMTP_USER"
                echo "SMTP_PASSWORD=\$SMTP_PASSWORD"
                echo "SMTP_FROM_EMAIL=\$SMTP_FROM_EMAIL"
                echo "SMTP_FROM_NAME=\$SMTP_FROM_NAME"
              fi
              
              echo "âš™ï¸ è¨­å®šç’°å¢ƒè®Šæ•¸..."
              {
                echo "DOCKER_USERNAME=\$DOCKER_USERNAME"
                echo "DATABASE_URL=\$DATABASE_URL"
                echo "JWT_SECRET=\$JWT_SECRET"
                echo "JWT_EXPIRES_IN=30d"
                echo "POSTGRES_USER=\$POSTGRES_USER"
                echo "POSTGRES_PASSWORD=\$POSTGRES_PASSWORD"
                echo "POSTGRES_DB=\$POSTGRES_DB"
                echo "NODE_ENV=production"
                echo "PUBLIC_GTM_ID=\$PUBLIC_GTM_ID"
                echo "GOOGLE_CLIENT_ID=\$GOOGLE_CLIENT_ID"
                echo "GOOGLE_CLIENT_SECRET=\$GOOGLE_CLIENT_SECRET"
                echo "GOOGLE_REDIRECT_URI=\$GOOGLE_REDIRECT_URI"
              } > .env
              echo \"ğŸš€ åŸ·è¡Œéƒ¨ç½²è…³æœ¬ï¼ˆåŒ…å« migrationsï¼‰...\"
              chmod +x deploy-prod.sh
              ./deploy-prod.sh
            '"; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼ç‰ˆæœ¬: $DEPLOY_VERSION"
              exit 0
            fi
            echo "âŒ éƒ¨ç½²å¤±æ•—ï¼Œ10 ç§’å¾Œé‡è©¦..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "âŒ é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œéƒ¨ç½²å¤±æ•—ï¼"
          exit 1

      - name: ğŸ¥ å¥åº·æª¢æŸ¥
        env:
          DEPLOY_URL: ${{ vars.DEPLOY_URL }}
        run: |
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "å˜—è©¦ $attempt/$max_attempts..."
            if curl -fsS "$DEPLOY_URL/api/health" > /dev/null; then
              echo "âœ… å¥åº·æª¢æŸ¥é€šéï¼"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 10
            attempt=$((attempt + 1))
          done
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼"
          exit 1

      - name: ğŸ§¹ æ¸…ç† SSH é‡‘é‘°
        if: always()
        run: shred -u ~/.ssh/deploy_key

  notify:
    name: ç™¼é€éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: ğŸ“¦ è®€å–ç‰ˆæœ¬
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ“£ ç™¼é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸš€ *éƒ¨ç½²é€šçŸ¥*

            *ç‹€æ…‹:* ${{ needs.deploy-production.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
            *å°ˆæ¡ˆ:* `${{ github.repository }}`
            *ç‰ˆæœ¬:* `${{ steps.get_version.outputs.version }}`
            *è§¸ç™¼æ–¹å¼:* `${{ github.event_name == 'release' && 'Release ç™¼å¸ƒ' || github.event_name == 'workflow_run' && 'CI Release å®Œæˆ' || 'æ‰‹å‹•è§¸ç™¼' }}`
            *æäº¤è€…:* `${{ github.actor }}`

            [æŸ¥çœ‹å·¥ä½œæµç¨‹](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
