name: CI Release

on:
  workflow_run:
    workflows: ['Auto Version Bump']
    types: [completed]
  workflow_dispatch:

jobs:
  build-docker:
    runs-on: ubuntu-latest
    # åªåœ¨ç‰ˆæœ¬å‡ç´šæˆåŠŸï¼ˆä¸”åœ¨ main åˆ†æ”¯ï¼‰æˆ–æ‰‹å‹•è§¸ç™¼æ™‚åŸ·è¡Œ
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    environment: production
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: æª¢æŸ¥è§¸ç™¼ä¾†æº
        run: |
          echo "ğŸ“‹ è§¸ç™¼äº‹ä»¶: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "âœ… ç”± Auto Version Bump å®Œæˆè§¸ç™¼"
            echo "ğŸ“¦ Version Bump çµæœ: ${{ github.event.workflow_run.conclusion }}"
          else
            echo "âœ… æ‰‹å‹•è§¸ç™¼"
          fi

      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: è®€å–ç‰ˆæœ¬è™Ÿ
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬è™Ÿç¢¼: $VERSION"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/moa:latest
            ${{ secrets.DOCKER_USERNAME }}/moa:v${{ steps.get_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/moa:${{ github.sha }}
          build-args: |
            DATABASE_URL=postgres://dummy:dummy@localhost:5432/dummy
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/moa:latest
          cache-to: type=inline
          platforms: linux/amd64,linux/arm64

      - run: echo "âœ… Docker æ˜ åƒå»ºç½®æˆåŠŸ"

  create-tag:
    name: å‰µå»ºç™¼å¸ƒæ¨™ç±¤
    runs-on: ubuntu-latest
    needs: build-docker
    # åœ¨ Auto Version Bump æˆåŠŸæˆ–æ‰‹å‹•è§¸ç™¼æ™‚å‰µå»ºæ¨™ç±¤èˆ‡ Release
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.check_version.outputs.tag }}
      should_release: ${{ steps.check_version.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          persist-credentials: true

      - name: æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²ç™¼å¸ƒ
        id: check_version
        run: |
          VERSION="${{ needs.build-docker.outputs.version }}"
          TAG="v${VERSION}"

          # ç¢ºä¿å–å¾—æ‰€æœ‰é ç«¯ tags
          git fetch --tags --force

          # æª¢æŸ¥è©²ç‰ˆæœ¬çš„ tag æ˜¯å¦å·²å­˜åœ¨ï¼ˆæœ¬åœ°æˆ–é ç«¯ï¼‰
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ ç‰ˆæœ¬ $TAG å·²å­˜åœ¨ï¼Œè·³éç™¼å¸ƒ"
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬ $TAG æ˜¯æ–°ç‰ˆæœ¬ï¼Œå°‡å‰µå»ºç™¼å¸ƒ"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: å‰µå»ºä¸¦æ¨é€æ¨™ç±¤
        if: steps.check_version.outputs.should_release == 'true'
        run: |
          VERSION="${{ needs.build-docker.outputs.version }}"
          TAG="v${VERSION}"
          SHORT_SHA=${GITHUB_SHA::7}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å‰µå»ºå¸¶è¨»è§£çš„æ¨™ç±¤
          git tag -a "$TAG" -m "Release $TAG" -m "Version: $VERSION" -m "Commit: $SHORT_SHA" -m "Triggered by: ${{ github.actor }}"
          git push origin "$TAG"

          echo "âœ… æ¨™ç±¤ $TAG å·²å‰µå»ºä¸¦æ¨é€"

      - name: ç”Ÿæˆ Release Notes
        if: steps.check_version.outputs.should_release == 'true'
        id: release_notes
        run: |
          VERSION="${{ needs.build-docker.outputs.version }}"
          TAG="v${VERSION}"

          # ç²å–ä¸Šä¸€å€‹ç‰ˆæœ¬æ¨™ç±¤
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [ -z "$PREV_TAG" ]; then
            echo "â„¹ï¸ é€™æ˜¯ç¬¬ä¸€å€‹ç‰ˆæœ¬ç™¼å¸ƒ"
            COMMITS="é¦–æ¬¡ç™¼å¸ƒ"
          else
            echo "ğŸ“ å¾ $PREV_TAG åˆ° $TAG çš„è®Šæ›´"
            # ç²å–å…©å€‹ç‰ˆæœ¬ä¹‹é–“çš„ commit è¨˜éŒ„
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges | head -n 20)
          fi

          # å°‡å¤šè¡Œå…§å®¹å„²å­˜åˆ° output
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: å‰µå»º GitHub Release
        if: steps.check_version.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.build-docker.outputs.version }}';
            const tag = 'v' + version;
            const shortSha = '${{ github.sha }}'.substring(0, 7);
            const prevTag = '${{ steps.release_notes.outputs.prev_tag }}';
            const commits = `${{ steps.release_notes.outputs.commits }}`;

            let body = `## ğŸš€ Release ${version}\n\n`;
            body += `**ç™¼å¸ƒæ™‚é–“:** ${new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}\n`;
            body += `**Commit:** ${shortSha}\n`;
            body += `**è§¸ç™¼è€…:** ${{ github.actor }}\n\n`;

            if (prevTag) {
              body += `### ğŸ“ æ›´æ–°å…§å®¹ (${prevTag} â†’ ${tag})\n\n${commits}\n\n`;
            } else {
              body += `### ğŸ“ é¦–æ¬¡ç™¼å¸ƒ\n\n`;
            }

            body += `### ğŸ“¦ Docker Images\n`;
            body += `\`\`\`\n`;
            body += `docker pull ${{ secrets.DOCKER_USERNAME }}/moa:latest\n`;
            body += `docker pull ${{ secrets.DOCKER_USERNAME }}/moa:v${version}\n`;
            body += `docker pull ${{ secrets.DOCKER_USERNAME }}/moa:${shortSha}\n`;
            body += `\`\`\`\n\n`;

            body += `### ğŸ”— ç›¸é—œé€£çµ\n`;
            body += `- [æŸ¥çœ‹ Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n`;
            body += `- [æŸ¥çœ‹ Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;

            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `Release ${tag}`,
                body: body,
                draft: false,
                prerelease: version.includes('-') || version.includes('alpha') || version.includes('beta')
              });
              
              console.log(`âœ… GitHub Release å·²å‰µå»º: ${release.data.html_url}`);
            } catch (error) {
              console.log(`âš ï¸ å‰µå»º Release å¤±æ•—: ${error.message}`);
              throw error;
            }

  notify:
    name: ç™¼å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-docker, create-tag]
    # åªåœ¨ build-docker å¯¦éš›åŸ·è¡Œï¼ˆéè·³éï¼‰ä¸”ï¼ˆå¤±æ•—æˆ–æˆåŠŸç™¼å¸ƒï¼‰æ™‚é€šçŸ¥
    if: |
      always() && 
      needs.build-docker.result != 'skipped' &&
      (needs.build-docker.result == 'failure' || needs.create-tag.outputs.should_release == 'true')
    steps:
      - name: ğŸ“£ ç™¼é€ç™¼å¸ƒé€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ${{ needs.build-docker.result == 'failure' && 'âŒ *Docker å»ºç½®å¤±æ•—*' || 'ğŸ‰ *æ–°ç‰ˆæœ¬ç™¼å¸ƒ*' }}

            *å°ˆæ¡ˆ:* `${{ github.repository }}`
            *ç‰ˆæœ¬:* `v${{ needs.build-docker.outputs.version }}`
            *æäº¤è€…:* `${{ github.actor }}`

            ${{ needs.build-docker.result == 'failure' && 'âš ï¸ Docker å»ºç½®å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤' || 'âœ… Docker æ˜ åƒå·²å»ºç½®ä¸¦æ¨é€' }}
            ${{ needs.create-tag.outputs.should_release == 'true' && format('âœ… Git tag å’Œ GitHub Release å·²å‰µå»º', '') || '' }}

            *Docker æ¨™ç±¤:*
            â€¢ `${{ secrets.DOCKER_USERNAME }}/moa:latest`
            â€¢ `${{ secrets.DOCKER_USERNAME }}/moa:v${{ needs.build-docker.outputs.version }}`

            [æŸ¥çœ‹è©³æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  trigger-deploy:
    name: è§¸ç™¼ç”Ÿç”¢éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [build-docker, create-tag]
    # åªåœ¨å»ºç«‹æ–°ç‰ˆæœ¬ä¸” Docker å»ºç½®æˆåŠŸæ™‚è§¸ç™¼éƒ¨ç½²
    if: |
      needs.build-docker.result == 'success' &&
      needs.create-tag.outputs.should_release == 'true'
    steps:
      - name: ğŸš€ è§¸ç™¼ CD å·¥ä½œæµç¨‹
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const version = '${{ needs.build-docker.outputs.version }}';
            const tag = '${{ needs.create-tag.outputs.tag }}';

            console.log('ğŸš€ æº–å‚™è§¸ç™¼ CD éƒ¨ç½²...');
            console.log(`   ç‰ˆæœ¬: ${version}`);
            console.log(`   Tag: ${tag}`);
            console.log('');

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'cd.yml',
                ref: 'main',
                inputs: {
                  version: version,
                  tag: tag
                }
              });
              
              console.log('âœ… CD å·¥ä½œæµç¨‹å·²æˆåŠŸè§¸ç™¼');
              console.log('â„¹ï¸ è«‹å‰å¾€ Actions é é¢æŸ¥çœ‹éƒ¨ç½²é€²åº¦');
              console.log(`ğŸ”— https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/cd.yml`);
            } catch (error) {
              console.error('âŒ è§¸ç™¼ CD å¤±æ•—:', error.message);
              console.error('è«‹æª¢æŸ¥ï¼š');
              console.error('1. PAT token æ˜¯å¦æœ‰æ­£ç¢ºè¨­å®š');
              console.error('2. PAT æ˜¯å¦æœ‰ workflow æ¬Šé™');
              console.error('3. cd.yml æª”æ¡ˆæ˜¯å¦å­˜åœ¨');
              throw error;
            }
