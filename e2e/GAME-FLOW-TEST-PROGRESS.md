# 遊戲流程測試進度追蹤

## 測試概述

測試完整的 8 人遊戲流程，包含鑑定、技能、指派三個階段，並驗證所有角色的特殊能力。

## 遊戲階段流程

1. **鑑定階段 (Identification Phase)**: 玩家鑑定獸首真偽
2. **技能階段 (Skill Phase)**: 玩家使用角色特殊技能
3. **指派階段 (Assign-Next Phase)**: 指定下一位行動玩家
4. **討論階段 (Discussion Phase)**: 所有人行動完畢後的討論
5. **投票階段 (Voting Phase)**: 房主點擊進入投票

---

## 測試項目清單

### ✅ 已完成 | ⏳ 進行中 | ❌ 未開始

### 1. 基礎設定

- [x] ✅ 改為 8 人遊戲
- [x] ✅ 驗證 8 人可以正常創建房間並開始遊戲
- [x] ✅ 驗證 8 個帳號註冊與登入功能
- [x] ✅ 驗證所有玩家可選擇不同角色（無重複）
- [x] ✅ 驗證房主點擊開始遊戲按鈕
- [x] ✅ 驗證所有玩家進入遊戲頁面

### 2. 許愿 (好人陣營)

**能力**: 可以鑑定 2 個獸首

- [x] ✅ 驗證許愿可以鑑定第一個獸首
- [x] ✅ 驗證許愿可以鑑定第二個獸首
- [x] ✅ 已實現點擊獸首卡片的測試邏輯 (使用 `.beast-card.interactive`)
- [ ] ⏳ 驗證許愿會受到老朝奉「真假互換」技能影響
- [ ] ⏳ 驗證真假互換後，許愿看到的鑑定結果相反

### 3. 方震 (好人陣營)

**能力**: 可以鑑定人（顯示該玩家陣營）

- [x] ✅ 驗證方震可以選擇玩家進行鑑定（在技能階段）
- [x] ✅ 已實現點擊玩家按鈕的測試邏輯 (使用 `.skills-section .player-btn-inline`)
- [x] ✅ 驗證方震可以看到目標玩家的陣營（從 notification 讀取）
- [x] ✅ 實現從 notification 中提取陣營信息（許愿陣營/老朝奉陣營）
- [x] ✅ **測試驗證**: 方震成功鑑定玩家並顯示正確陣營
  - 回合1: 鑑定到老朝奉陣營
  - 回合2: 鑑定到許愿陣營
  - 回合3: 鑑定到許愿陣營
- [ ] ❌ 驗證方震被藥不然攻擊時，許愿也會同時被攻擊（遊戲規則特性，需要特定測試場景）

### 4. 木戶加奈 (好人陣營)

**能力**: 可以鑑定一個獸首，隨機一回合無法鑑定

- [x] ✅ 驗證木戶加奈可以正常鑑定獸首
- [x] ✅ 已實現獸首鑑定邏輯 (使用 `.beast-card.interactive`)
- [ ] ⏳ 驗證木戶加奈某回合無法鑑定（被沉默）
- [ ] ⏳ 驗證被沉默回合遭受藥不然攻擊時，顯示「被藥不然攻擊」而非「被沉默」
- [ ] ⏳ 驗證沉默結束後可以恢復鑑定

### 5. 黃煙煙 (好人陣營)

**能力**: 可以鑑定一個獸首，隨機一回合無法鑑定

- [x] ✅ 驗證黃煙煙可以正常鑑定獸首
- [x] ✅ 已實現獸首鑑定邏輯 (使用 `.beast-card.interactive`)
- [ ] ⏳ 驗證黃煙煙某回合無法鑑定（被沉默）
- [ ] ⏳ 驗證被沉默回合遭受藥不然攻擊時，顯示「被藥不然攻擊」而非「被沉默」
- [ ] ⏳ 驗證沉默結束後可以恢復鑑定

### 6. 姬云浮 (好人陣營)

**能力**: 可以鑑定一個獸首，不受老朝奉技能影響，被攻擊後永久無法鑑定

- [x] ✅ 驗證姬云浮可以正常鑑定獸首
- [x] ✅ 已實現獸首鑑定邏輯 (使用 `.beast-card.interactive`)
- [ ] ⏳ 驗證姬云浮不受老朝奉「真假互換」技能影響
- [ ] ⏳ 驗證姬云浮被藥不然攻擊後無法鑑定
- [ ] ⏳ 驗證姬云浮被攻擊後，未來所有回合都無法鑑定

### 7. 老朝奉 (壞人陣營)

**能力**: 可以鑑定一個獸首，可以使用「交換」技能（真假互換）

- [x] ✅ 驗證老朝奉可以正常鑑定獸首
- [x] ✅ 驗證老朝奉可以使用交換技能
- [x] ✅ 已實現交換技能按鈕點擊邏輯
- [x] ✅ 已追蹤交換技能使用狀態 (swapUsed)
- [x] ✅ **測試驗證**: 老朝奉成功使用交換技能（每次測試都記錄到使用）
- [ ] ⏳ 驗證交換技能對許愿生效（鑑定結果相反）- 需要進階測試
- [ ] ⏳ 驗證交換技能對姬云浮無效 - 需要進階測試

### 8. 藥不然 (壞人陣營)

**能力**: 可以鑑定一個獸首，可以攻擊玩家

- [x] ✅ 驗證藥不然可以正常鑑定獸首
- [x] ✅ 驗證藥不然可以選擇玩家進行攻擊
- [x] ✅ 已實現攻擊玩家按鈕點擊邏輯 (使用 `.player-btn-inline`)
- [x] ✅ 已追蹤被攻擊玩家狀態 (attackedPlayers)
- [x] ✅ **測試驗證**: 藥不然成功攻擊多個玩家（每回合攻擊1-2個玩家）
- [x] ✅ 驗證被攻擊的玩家顯示「被攻擊」狀態
- [x] ✅ 驗證被攻擊的玩家該回合無法鑑定但可以指派
- [ ] ⏳ 驗證攻擊方震時，許愿也會同時被攻擊 - 需要進階測試

### 9. 鄭國渠 (壞人陣營)

**能力**: 可以鑑定一個獸首，可以封鎖獸首

- [x] ✅ 驗證鄭國渠可以正常鑑定獸首
- [x] ✅ 驗證鄭國渠可以選擇獸首進行封鎖
- [x] ✅ 已實現封鎖獸首按鈕點擊邏輯 (使用 `.beast-card.interactive`)
- [x] ✅ 已追蹤被封鎖獸首狀態 (blockedArtifacts)
- [x] ✅ **測試驗證**: 鄭國渠成功封鎖獸首（每回合封鎖1個，共3個）
- [x] ✅ 驗證被封鎖的獸首在遊戲記錄中正確追蹤
- [ ] ⏳ 驗證封鎖後，後面的玩家鑑定該獸首時顯示「無法鑑定」- 需要進階測試
- [ ] ⏳ 驗證封鎖效果持續到回合結束 - 需要進階測試

### 10. 討論與投票階段

- [x] ✅ 驗證所有玩家行動完畢後，最後一位玩家可以點擊「進入討論」
- [x] ✅ 驗證進入討論階段後，所有玩家都看到討論界面
- [x] ✅ 驗證房主可以點擊「進入投票」按鈕
- [x] ✅ 已實現指派下一位玩家的邏輯 (使用 `.player-btn-inline`)

### 11. 投票階段

- [x] ✅ 驗證投票界面正確顯示所有獸首
- [x] ✅ 驗證可以為不同獸首投票
- [x] ✅ 驗證投票輸入任意兩樣獸首各一票
- [x] ✅ 已實現投票邏輯框架
- [x] ✅ 實現房主輸入投票數功能（隨機選擇兩個獸首各1票）
- [x] ✅ 實現提交投票結果功能（點擊提交按鈕 + 確認對話框）
- [x] ✅ 驗證投票結果顯示（顯示前兩名獸首、票數、第二名真偽）
- [x] ✅ 實現讀取投票結果功能（排名、獸首名稱、票數、狀態）

### 12. 多回合流程

- [x] ✅ 驗證投票結果顯示後，房主可點擊「開始下一回合」
- [x] ✅ 實現自動進入下一回合邏輯（第1、2回合後）
- [x] ✅ 驗證第3回合後不再繼續，準備進入結算
- [x] ✅ 實現完整的多回合循環測試

---

## 測試執行指令

### 執行所有 E2E 測試

```powershell
npm run test:e2e
```

### 只執行遊戲流程測試

```powershell
npx playwright test game-flow
```

### 執行特定測試並顯示瀏覽器

```powershell
npx playwright test game-flow --headed
```

### 執行測試並生成報告

```powershell
npx playwright test game-flow --reporter=html
```

### 查看測試報告

```powershell
npx playwright show-report
```

---

## 測試數據說明

### 角色配置 (8 人遊戲)

- **好人陣營 (5人)**: 許愿、黃煙煙、方震、木戶加奈、姬云浮
- **壞人陣營 (3人)**: 老朝奉、鄭國渠、藥不然

### 獸首配置

- 12 個生肖獸首: 鼠、牛、虎、兔、龍、蛇、馬、羊、猴、雞、狗、豬
- 每個獸首有真假兩種狀態

---

## 當前測試狀態 ✅

### 核心功能 - 已完成

- ✅ **基礎遊戲流程**: 8人遊戲從註冊到3回合完整流程
- ✅ **所有角色基本能力**: 鑑定獸首、鑑定玩家、使用技能
- ✅ **特殊技能**: 老朝奉交換、藥不然攻擊、鄭國渠封鎖
- ✅ **方震陣營鑑定**: 在技能階段鑑定玩家並從 notification 讀取陣營
- ✅ **投票流程**: 完整的討論、投票、結果顯示、下一回合
- ✅ **多回合循環**: 自動執行3個回合的完整測試

### 進階功能 - 待實現（需要專門測試場景）

這些功能需要設計特定的測試場景，涉及遊戲規則的複雜互動：

1. **真假互換效果驗證** (許愿 & 姬云浮)
   - 需要追蹤老朝奉使用交換技能前後的鑑定結果
   - 驗證許愿看到相反的結果
   - 驗證姬云浮不受影響

2. **攻擊效果驗證** (藥不然)
   - 驗證被攻擊玩家在當前/下一回合無法行動
   - 驗證攻擊方震時許愿也被攻擊（特殊規則）
   - 驗證姬云浮被攻擊後永久無法鑑定

3. **封鎖效果驗證** (鄭國渠)
   - 驗證被封鎖的獸首無法被後續玩家鑑定
   - 驗證封鎖效果持續到回合結束

4. **沉默效果驗證** (木戶加奈 & 黃煙煙)
   - 驗證隨機回合被沉默無法鑑定
   - 驗證沉默優先級（被攻擊 > 被沉默）

### 實現建議

剩餘的進階功能驗證可以透過以下方式實現：

1. **創建專門的測試案例**: 針對每個特殊規則創建獨立測試
2. **Mock 隨機事件**: 控制沉默發生的回合
3. **追蹤遊戲狀態**: 記錄技能使用前後的狀態變化
4. **比對預期結果**: 驗證遊戲規則是否正確執行

### 進階測試文件

已創建 `game-flow-advanced.test.ts` 包含以下測試框架：

1. ✅ **測試 1**: 老朝奉交換技能效果驗證
2. ✅ **測試 2**: 鄭國渠封鎖效果驗證
3. ✅ **測試 3**: 藥不然攻擊未行動玩家
4. ✅ **測試 4**: 藥不然攻擊已行動玩家
5. ✅ **測試 5**: 攻擊方震連帶攻擊許愿
6. ✅ **測試 6**: 姬云浮被攻擊後永久無法鑑定
7. ✅ **測試 7**: 木戶加奈隨機沉默效果
8. ✅ **測試 8**: 黃煙煙隨機沉默效果
9. ✅ **測試 9**: 沉默與攻擊的優先級

**測試狀態**: 測試框架已建立（標記為 `skip`），需要根據遊戲實際實現逐步填充測試邏輯。

**實現優先級**:

- 🔥 高優先級: 測試 1, 2, 3（核心技能效果）
- ⚡ 中優先級: 測試 4, 5, 6（特殊規則互動）
- 📝 低優先級: 測試 7, 8, 9（隨機事件需要 mock）

目前的測試已經涵蓋了**核心遊戲流程和基本功能**，可以確保遊戲的主要功能正常運作。

---

## 注意事項

1. 測試前確保資料庫已初始化
2. 測試使用獨立的測試用戶，避免與生產數據衝突
3. 每次測試後會自動清理測試數據
4. 測試超時時間設定為 20 分鐘，可根據需要調整

---

## 更新日誌

### 2025-01-31

- [x] ✅ 創建測試進度追蹤文件
- [x] ✅ 規劃 8 人遊戲測試流程
- [x] ✅ 定義所有角色能力測試項目
- [x] ✅ 修改測試為 8 人遊戲
- [x] ✅ 實現 8 個帳號註冊與登入
- [x] ✅ 修正角色選擇重複問題（使用 selectedRoles 追蹤）
- [x] ✅ 改進玩家行動檢測邏輯（PlayerOrderDisplay + GameHeader）
- [x] ✅ 閱讀組件源碼以了解正確的選擇器
- [x] ✅ 更新測試選擇器：
  - 獸首卡片: `.beast-card.interactive` (ArtifactDisplay)
  - 玩家按鈕: `.player-btn-inline` (SkillPhase, AssignPhase)
  - 當前玩家: `.current-player` (PlayerOrderDisplay)
  - 角色顯示: `.role-highlight` (GameHeader)
- [x] ✅ 實現基礎遊戲流程測試（鑑定 > 技能 > 指派）
- [x] ✅ 添加許愿雙重鑑定測試
- [x] ✅ 添加方震鑑定玩家測試
- [x] ✅ 添加老朝奉交換技能測試（含 swapUsed 追蹤）
- [x] ✅ 添加藥不然攻擊玩家測試（含 attackedPlayers 追蹤）
- [x] ✅ 添加鄭國渠封鎖獸首測試（含 blockedArtifacts 追蹤）
- [x] ✅ 添加討論與投票階段測試
- [x] ✅ 實現投票階段完整流程：
  - 最後一位玩家點擊「進入討論」按鈕
  - 房主點擊「進入投票」按鈕
  - 房主隨機選擇兩個獸首各投1票
  - 房主點擊「提交投票結果」
  - 確認對話框中點擊「確認提交」
- [x] ✅ 實現投票結果顯示與下一回合流程：
  - 等待投票結果顯示（顯示前兩名獸首）
  - 讀取並記錄排名、獸首名稱、票數、真偽狀態
  - 房主點擊「開始第X回合」按鈕
  - 自動進入下一回合繼續測試
  - 完成3個回合的完整測試循環
- [x] ✅ 實現 modal 確認邏輯（鑑定獸首、攻擊玩家、封鎖獸首、投票提交）
- [x] ✅ 實現被攻擊玩家處理邏輯（確認 modal、標記已行動）
- [x] ✅ 代碼重構：抽取 identifyArtifact 和 assignNextPlayer 輔助函數
- [x] ✅ 修復方震鑑定玩家邏輯：從鑑定階段移至技能階段
- [x] ✅ 修復方震按鈕選擇器：使用 `.skills-section .player-btn-inline` 避免與指派按鈕混淆
- [x] ✅ 實現 notification 讀取：從 `.notification-toast .toast-message` 讀取鑑定結果
- [x] ✅ 修復代碼縮進問題：確保所有玩家行動邏輯在正確的作用域內
- [ ] ⏳ 待驗證：所有角色特殊能力的詳細效果（交換影響、攻擊效果、封鎖效果）

### 2025-11-05

- [x] ✅ 修復遊戲流程測試的關鍵問題：
  - 修復投票按鈕文字（"進入投票" → "開始投票"）
  - 修復投票輸入選擇器
  - 修復投票確認按鈕選擇器
  - 修復投票結果檢測邏輯
  - 修復回合循環 bug（for loop → while loop）
  - 添加技能階段完成按鈕自動點擊
  - 修復方震鑑定玩家位置（鑑定階段 → 技能階段）
  - 實現 notification 陣營信息讀取
- [x] ✅ 測試完全通過（Exit Code: 0）
- [x] ✅ 所有 8 位玩家在 3 個回合中正常行動
- [x] ✅ 完整的遊戲流程測試成功（註冊 → 登入 → 房間 → 角色選擇 → 3回合遊戲 → 投票）
- [x] ✅ 創建進階測試文件框架（game-flow-advanced.test.ts）
- [x] ✅ 創建進階測試文檔（ADVANCED-TESTS-README.md）
- [x] ✅ 實現鄭國渠封鎖效果測試（第一個進階測試）

---

## 📚 測試文件說明

### 主要測試文件

1. **game-flow.test.ts** - 核心功能完整測試（✅ 已完成）
   - 8人完整遊戲流程
   - 所有角色基本功能
   - 3回合循環測試

2. **game-flow-advanced.test.ts** - 進階功能測試（🔨 進行中）
   - 技能效果驗證
   - 特殊規則互動
   - 9個測試場景框架

3. **ADVANCED-TESTS-README.md** - 進階測試指南
   - 測試實現步驟
   - 調試技巧
   - 貢獻指南

### 快速執行指令

```bash
# 執行核心測試
npx playwright test game-flow --workers=1

# 執行進階測試
npx playwright test game-flow-advanced --workers=1

# 執行所有測試
npx playwright test e2e --workers=1

# 生成測試報告
npx playwright test --reporter=html
npx playwright show-report
```
